<!-- 出勤模式 -->
<template>
  <!-- :full-sub-index="[1, 2]" -->
  <cmp-container :full="false">
    <cmp-card>
      <cmp-query :opts="opts" :bool-enter="true" @submit="onInput">
        <template #shiftCode="{ param }">
          <t-select v-model="param.shiftCode" :clearable="true" label="班次">
            <t-option v-for="item in shiftDataList" :key="item.value" :label="item.label" :value="item.value" />
          </t-select>
        </template>
      </cmp-query>
    </cmp-card>
    <cmp-card>
      <!-- ################# 班组表格数据 ###################### -->
      <cmp-table
        ref="tableRef"
        v-model:pagination="pageUI"
        empty="没有符合条件的数据"
        row-key="id"
        :hover="false"
        :stripe="false"
        :fixed-height="false"
        :table-column="shiftColumns"
        active-row-type="single"
        :table-data="teamList.list"
        :total="teamTotal"
        :selected-row-keys="selectedRowKeys"
        @row-click="onGroupSelectChange"
        @select-change="onSelectChange"
        @refresh="onFetchGroupData"
      >
        <template #actionSlot="{ row }">
          <t-space :size="8">
            <t-link theme="primary" @click="onEditRow(row)">{{ '编辑' }}</t-link>
            <t-popconfirm theme="default" content="确认删除吗" @confirm="onDelConfirm()">
              <t-link theme="primary" @click="onGroupDelect(row)">{{ '删除' }}</t-link>
            </t-popconfirm>
          </t-space>
        </template>
        <template #button>
          <t-space :size="8">
            <t-button theme="primary" @click="onAddTypeData"> 新增班组 </t-button>
            <t-popconfirm theme="default" content="确认删除吗" @confirm="onTeamDeleteBatches()">
              <t-button theme="default"> 班组批量删除 </t-button>
            </t-popconfirm>
            <t-button theme="default"> 班组导入 </t-button>
          </t-space>
        </template>
      </cmp-table>
    </cmp-card>
  </cmp-container>

  <!-- #班组 dialog 弹窗 -->
  <t-dialog v-model:visible="formVisible" :cancel-btn="null" :confirm-btn="null" :header="diaLogTitle">
    <t-form ref="formRef" :rules="rules" :data="teamFormData" @submit="onAnomalyTypeSubmit">
      <!-- 第 1️⃣ 行数据 -->
      <t-row :gutter="[32, 16]">
        <t-col :span="6">
          <t-form-item label="出勤模式编码" name="modeCode">
            <t-input v-model="teamFormData.modeCode" :disabled="groupDisabled"></t-input>
          </t-form-item>
        </t-col>
        <t-col :span="6">
          <t-form-item label="出勤模式名称" name="modeName">
            <t-input v-model="teamFormData.modeName" :disabled="groupDisabled"></t-input>
          </t-form-item>
        </t-col>
        <!-- 第 2️⃣ 行数据 -->
        <t-col :span="6">
          <t-form-item label="出勤模式描述" name="modeDesc">
            <t-input v-model="teamFormData.modeDesc" :disabled="groupDisabled"></t-input>
          </t-form-item>
        </t-col>
        <t-col :span="6">
          <t-form-item label="班次" name="shiftCode">
            <t-select v-model="teamFormData.shiftCode" :clearable="true">
              <t-option v-for="item in shiftDataList" :key="item.value" :label="item.label" :value="item.value" />
            </t-select>
          </t-form-item>
        </t-col>
        <!-- 第 3️⃣ 行数据 -->
        <t-row
          v-for="(timeRange, index) in teamFormData.expression"
          :key="index"
          justify="space-between"
          align="center"
        >
          <t-col :span="10">
            <t-form-item :label="'时间段' + (index + 1)" :name="'expression' + index">
              <t-time-range-picker
                v-model="teamFormData.expression[index]"
                class="demos"
                clearable
                format="HH:mm"
                allow-input
              />
            </t-form-item>
          </t-col>
          <t-col :span="2" style="text-align: center">
            <icon
              v-if="teamFormData.expression.length > 1"
              name="minus-circle"
              size="1.5em"
              @click="() => delFormSubmit(index)"
            />
          </t-col>
        </t-row>
      </t-row>
      <!--# 🌈添加按钮 -->
      <t-row justify="center" style="margin-top: 16px">
        <t-button block variant="outline" style="width: 90%" @click="addFormSubmit">添加</t-button>
      </t-row>
    </t-form>
    <template #footer>
      <t-button theme="default" variant="base" @click="formVisible = false">取消</t-button>
      <t-button theme="primary" @click="eidtFormSubmit">保存</t-button>
    </template>
  </t-dialog>
</template>

<script setup lang="ts">
import { Icon } from 'tdesign-icons-vue-next';
import { FormInstanceFunctions, FormRules, MessagePlugin, PrimaryTableCol, TableRowData } from 'tdesign-vue-next';
import { computed, onMounted, reactive, Ref, ref } from 'vue';

import { api } from '@/api/main';
import CmpQuery from '@/components/cmp-query/index.vue';
import CmpTable from '@/components/cmp-table/index.vue';
import { usePage } from '@/hooks/modules/page';

const defaultTimeRange = ['', '']; // 默认时间范围
const teamFormData = ref({
  modeCode: '', // 出勤模式编码
  modeName: '', // 出勤模式名称
  modeDesc: '', // 出勤模式描述
  shiftCode: '', // 班次
  expression: [defaultTimeRange], // 初始时包含一个默认时间范围
});

// 转化成分钟
function timeToMinutes(time) {
  const [hours, minutes] = time.split(':').map(Number);
  return hours * 60 + minutes;
}

// 得到 一个分钟 组成的数组
function convertAndFlattenTimeIntervals(timeIntervals) {
  return timeIntervals.flatMap((interval) => interval.map(timeToMinutes));
}

// 判断时间是否超过了24小时
function processTimeArray(timeArray) {
  console.log('🚀 ~ file: index.vue:154 ~ processTimeArray ~ timeArray:', timeArray);
  // for (let i = 0; i < timeArray.length - 1; i++) {
  //   if (timeArray[i] + 1440 <= timeArray[j]) {
  //     return false; // 跳出循环，但不结束整个函数
  //   }
  // }
  return true; // 没有超过24小时则返回 true
}

// 添加时间组件
const addFormSubmit = () => {
  const flattenedConvertedIntervals = convertAndFlattenTimeIntervals(teamFormData.value.expression);
  const AAA = flattenedConvertedIntervals.every((element) => Boolean(element));
  if (!AAA) {
    MessagePlugin.warning('时间段不能为空！');
    return;
  }
  const flag = processTimeArray(flattenedConvertedIntervals);
  if (!flag) {
    MessagePlugin.warning('时间间隔不能超过24小时，请重新输入！');
    return;
  }
  // if (flattenedConvertedIntervals[0] > flattenedConvertedIntervals[flattenedConvertedIntervals.length - 1]) {
  //   MessagePlugin.warning('请正确填写时间！');
  //   return; // 如果第一个元素大于最后一个元素，则直接返回
  // }
  teamFormData.value.expression.push([...defaultTimeRange]); // 添加新的时间范围
};

// 删除时间组件
const delFormSubmit = (index: number) => {
  teamFormData.value.expression.splice(index, 1);
};

// const { t } = useLang();
const formRef: Ref<FormInstanceFunctions> = ref(null); // 新增表单数据清除，获取表单实例
const { pageUI } = usePage(); // 分页工具
const { pageUI: personPage } = usePage();
const formVisible = ref(false); // 控制 班组dialog 弹窗显示隐藏
const diaLogTitle = ref(''); // 弹窗标题
const selectedRowKeys: Ref<any[]> = ref([]); // 删除计量单位 id
const groupDisabled = ref(false); // 班组表单禁用开关
const submitFalg = ref(false);

// $班组 表格数据
const teamList = reactive({ list: [] });
// 班组表格数据总条数
const teamTotal = ref(0);
// $人员 表格数据
const supportPersonInUserList = reactive({ list: [] });
// 人员表格数据总条数
const supportPersonTotal = ref(0);
// dialog 弹框数据
// 初始渲染
onMounted(async () => {
  await onShiftSelectData(); // 班次下拉数据获取
});

// 班次下拉数据获取
const shiftDataList = ref([]);
const onShiftSelectData = async () => {
  const res = await api.param.getListByGroupCode({ parmGroupCode: 'SHIFT_CODE' });
  shiftDataList.value = res;
};

// ####班次 表头
const shiftColumns: PrimaryTableCol<TableRowData>[] = [
  {
    colKey: 'row-select',
    type: 'multiple',
    width: 46,
  },
  {
    colKey: 'modeCode',
    title: '出勤模式编码',
    align: 'center',
    width: '100',
  },
  {
    colKey: 'modeName',
    title: '出勤模式名称',
    align: 'center',
    width: '100',
  },
  {
    colKey: 'modeDesc',
    title: '出勤模式描述',
    align: 'center',
    width: '130',
  },
  {
    colKey: 'shiftName',
    title: '班次',
    align: 'center',
    width: '80',
  },
  {
    colKey: 'expression',
    title: '工作时间',
    align: 'center',
    width: '150',
  },
  {
    colKey: 'actionSlot',
    title: '操作',
    align: 'center',
    fixed: 'right',
    width: '130',
  },
];

// # 班组刷新按钮
const onFetchGroupData = async () => {
  await onShiftTabData(); // 获取 班组表格 数据
  selectedRowKeys.value = [];
  supportPersonInUserList.list = [];
  supportPersonTotal.value = 0;
  rowGroupId.value = '';
};

// 表单定义规则
const rules: FormRules = {
  modeCode: [{ required: true, trigger: 'blur' }],
  modeName: [{ required: true, trigger: 'blur' }],
  shiftCode: [{ required: true, trigger: 'change' }],
};
// # 初始渲染
onMounted(async () => {
  await onShiftTabData(); // 获取 班组表格 数据
});

// #班组搜索
const opts = computed(() => {
  return {
    keyword: { label: '出勤模式名称', comp: 't-input', event: 'input', defaultval: '' },
    shiftCode: { label: '班次', defaultVal: '', slotName: 'shiftCode' },
  };
});
// 上侧搜索提交事件
const onInput = async (data: any) => {
  pageUI.value.page = 1;
  personPage.value.page = 1;
  teamParam.value.keyword = data.keyword;
  teamParam.value.shiftCode = data.shiftCode;
  await onShiftTabData();
  selectedRowKeys.value = [];
  supportPersonInUserList.list = [];
  supportPersonTotal.value = 0;
  rowGroupId.value = '';
};

const eidtFormSubmit = () => {
  formRef.value.submit();
};

// #出勤表格 参数
const teamParam = ref({
  pageNum: 1,
  pageSize: 20,
  keyword: '', // 出勤模式名称
  shiftCode: '', // 班次
});

// #获取 出勤表格 数据
const onShiftTabData = async () => {
  teamParam.value.pageNum = pageUI.value.page;
  teamParam.value.pageSize = pageUI.value.rows;
  const res = await api.attendanceMode.getList(teamParam.value);
  teamList.list = res.list;
  teamTotal.value = res.total;
};

// function processExpression(expression) {
//   let addN = false;
//   const formattedRanges = [];
//   let lastEndTime = 0;
//   let suffixN = false;
//   let previousEndTime = convertToMinutes(expression[0][0]); // 开始时间
//   console.log('🚀 ~ file: index.vue:300 ~ processExpression ~ previousEndTime:', previousEndTime);

//   // // 首先检查是否有时间段超过24小时
//   for (let i = 0; i < expression.length; i++) {
//     const [startTime, endTime] = expression[i].map(convertToMinutes);
//     console.log('🚀 ~ file: index.vue:304 ~ processExpression ~ startTime:', startTime);
//     console.log('🚀 ~ file: index.vue:304 ~ processExpression ~ endTime:', endTime);
//     if (endTime - startTime > 24 * 60) {
//       throw new Error('A time span exceeds 24 hours');
//     }
//     if (i > 0 && convertToMinutes(expression[i - 1][1]) > startTime) {
//       suffixN = true;
//     }
//     lastEndTime = suffixN ? endTime + 24 * 60 : endTime;
//   }
//   // 检查总时间跨度是否超过24小时
//   if (lastEndTime - convertToMinutes(expression[0][0]) > 24 * 60) {
//     throw new Error("Total span with 'n' exceeds 24 hours");
//   }

//   for (let i = 0; i < expression.length; i++) {
//     const [startTimeStr, endTimeStr] = expression[i];
//     const startTime = convertToMinutes(startTimeStr);
//     const endTime = convertToMinutes(endTimeStr);
//     // 如果当前开始时间大于结束时间或者小于上一组结束时间
//     if (startTime > endTime || startTime < previousEndTime) {
//       addN = true;
//     }
//     // 格式化时间范围
//     const formattedStartTime = `${startTimeStr}${addN ? 'N' : ''}`;
//     const formattedEndTime = `${endTimeStr}${addN ? 'N' : ''}`;
//     formattedRanges.push(`${formattedStartTime}-${formattedEndTime}`);
//     // 更新上一组的结束时间
//     previousEndTime = endTime;
//   }
//   return formattedRanges;
// }

// #添加 班组 数据请求
const onAddSupportGroup = async () => {
  const flattenedConvertedIntervals = convertAndFlattenTimeIntervals(teamFormData.value.expression);
  console.log('🚀 ~ file: index.vue:322 ~ onAddSupportGroup ~ replacement_times :', flattenedConvertedIntervals);
  // await api.attendanceMode.addAttendanceMode(teamFormData.value);
  // await onShiftTabData(); // 获取 班组表格 数据
  // MessagePlugin.success('新增成功');
};

// #添加按钮点击事件
const onAddTypeData = async () => {
  formRef.value.reset({ type: 'empty' });
  groupDisabled.value = false; // 关闭表单禁用
  submitFalg.value = true; // true为新增
  formVisible.value = true;
  diaLogTitle.value = '出勤模式新增';
};

// #编辑 点击 班组右侧表格编辑按钮
const workGroupRowId = ref('');
const onEditRow = (row: any) => {
  groupDisabled.value = true; // 启用表单禁用
  teamFormData.value.modeCode = row.modeCode; // 班组代码
  teamFormData.value.modeName = row.modeName; // 班组名称
  teamFormData.value.modeDesc = row.modeDesc; // 班组描述
  teamFormData.value.shiftCode = row.shiftCode; // 车间 ID
  workGroupRowId.value = row.id;
  submitFalg.value = false; // 编辑为 false
  formVisible.value = true;
  diaLogTitle.value = '编辑班组';
};

// #编辑 班组 表格数据 请求
const onGroupRequest = async () => {
  await api.workgroup.modifyWorkgroup({ ...teamFormData.value, id: workGroupRowId.value });
  await onShiftTabData(); // 获取 班组表格 数据
  MessagePlugin.success('编辑成功');
};

// ！删除 获取 班组 批量删除数组
const onSelectChange = (value) => {
  selectedRowKeys.value = value;
};

const rowGroupId = ref(''); // 点击行ID
const onGroupSelectChange = async ({ row }) => {
  rowGroupId.value = row.id;
};

// ！ 删除 单项删除 班组 点击
const onGroupDelect = (row: any) => {
  selectedRowKeys.value = [];
  selectedRowKeys.value.push(row.id);
};

// ！班组表格删除确认按钮
const onDelConfirm = async () => {
  await api.workgroup.removeWorkgroupBatch([rowGroupId.value]);
  if (teamList.list.length <= 1 && pageUI.value.page > 1) {
    pageUI.value.page--;
  }
  await onShiftTabData(); // 获取 班组表格 数据
  MessagePlugin.success('删除成功');
  selectedRowKeys.value = []; // 置空
};

// ！班组表格批量删除按钮
const onTeamDeleteBatches = async () => {
  // 步骤 1: 检查删除前的数据总量
  const initialLength = teamList.list.length;
  // 步骤 2: 执行删除操作
  await api.workgroup.removeWorkgroupBatch(selectedRowKeys.value);
  // 步骤 3: 检查当前页是否还有数据
  if (initialLength === teamList.list.length && pageUI.value.page > 1) {
    // 如果删除的数据量等于当前页的数据量，并且不在第一页，则页码减一
    pageUI.value.page--;
  }
  MessagePlugin.success('批量删除成功');
  await onShiftTabData(); // 获取 班组表格 数据
  selectedRowKeys.value = []; // 置空
};

// @表单提交事件
const onAnomalyTypeSubmit = async (context: { validateResult: boolean }) => {
  console.log('🚀 ~ file: index.vue:374 ~ onAnomalyTypeSubmit ~ teamFormData.value:', teamFormData.value);

  if (context.validateResult === true) {
    if (submitFalg.value) {
      await onAddSupportGroup(); // 新增请求
    } else {
      await onGroupRequest(); // 编辑请求
    }
    formVisible.value = false;
  }
};
</script>

<style lang="less" scoped>
.module-tree-container {
  padding: var(--td-comp-paddingTB-xxl) var(--td-comp-paddingLR-xxl);
  background-color: var(--td-bg-color-container);
  border-radius: var(--td-radius-medium);
}

.align-right {
  display: flex;
  justify-content: flex-end;
}

.filled-icon {
  color: var(--td-success-color);
}
</style>
